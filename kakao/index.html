  <!-- Bong-lyd for trippy effekt -->
  <audio id="bongSound" src="bong.mp3" preload="auto"></audio>

<!DOCTYPE html>
<html lang="no">
  <head>
    <meta charset="utf-8">
    <title>SkÃ¦kkulator</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
/* ===== BODY ===== */
body {
  font-family: Arial, sans-serif;
  max-width: 780px;
  margin: 20px auto;
  background: #222;
  padding: 18px;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.6);
  color: #eee;
  padding-bottom: calc(18px + env(safe-area-inset-bottom));
}

/* ===== TEXT ===== */
p.lead {
  text-align: center;
  position: relative; /* Ensure positioning for overlay */
  color: #bbb;
  margin: 0 0 12px;
  font-size: 14px;
}

label {
  display: block;
  margin-top: 12px;
  font-weight: 600;
  color: #ddd;
}

small, .meta {
  color: #aaa;
  font-size: 13px;
  margin-top: 6px;
}

/* ===== TITLE + WEED ===== */
.title-wrapper {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-bottom: 10px;
}

.title-wrapper h1 {
  margin: 0;
  font-size: 1.8em;
  color: #eee;
}

.title-wrapper img {
  width: 40px;
  height: 40px;
  object-fit: contain;
}
.weed {
  animation: floatWeed 3s ease-in-out infinite alternate;
}
.weed-right {
  animation: floatWeedRight 3s ease-in-out infinite alternate;
}

/* subtle float */
@keyframes floatWeed {
  0%   { transform: translateY(0) rotate(0deg); }
  50%  { transform: translateY(-5px) rotate(-8deg); }
  100% { transform: translateY(0) rotate(8deg); }
}
@keyframes floatWeedRight {
  0%   { transform: translateY(0) rotate(0deg); }
  50%  { transform: translateY(-5px) rotate(8deg); }
  100% { transform: translateY(0) rotate(-8deg); }
}

/* ===== INPUTS ===== */
input, select {
  width: 100%;
  margin-top: 6px;
  padding: 8px 10px;
  border-radius: 6px;
  border: 1px solid #444;
  background: #111;
  color: #eee;
  font-size: 14px;
  box-sizing: border-box;
}

input::placeholder { color: #777; }

/* ===== LAYOUT ===== */
.row { display: flex; gap: 12px; }
.col { flex: 1; }

.checkbox-inline {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}
.checkbox-inline input { margin: 0; width: auto; }

/* ===== BUTTONS ===== */
button {
  margin-top: 16px;
  padding: 12px;
  width: 100%;
  font-size: 16px;
  border-radius: 8px;
  border: 0;
  background: #444;
  color: #fff;
  cursor: pointer;
}
button:hover { background: #555; }

/* ===== FORCE REFRESH ===== */
#forceRefreshBtn {
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 0 auto 12px;
  width: 16px;
  height: 16px;
  min-width: 36px;
  min-height: 36px;
  max-width: 90vw;
  max-height: 90vw;
  padding: 0;
  font-size: 14px;
  background: #555;
  color: #fff;
  border-radius: 8px;
  cursor: pointer;
  text-align: center;
  box-sizing: border-box;
  user-select: none;
}
#forceRefreshBtn:hover { background: #666; }

/* ===== RESULT ===== */
#result {
  display: none;
  margin-top: 18px;
  padding: 12px;
  border-radius: 8px;
  background: #1c1c1c;
  border: 1px solid #333;
}

.warn {
  display: none;
  background: #2a1d00;
  border: 1px solid #8a5a00;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 10px;
  color: #ffcc80;
}

/* =========================================================
   ğŸŒ¿ WEED EFFECTS (REN, KORREKT, INGEN DUPLIKATER)
   ========================================================= */

/* BASE: svak hvit glow ALLTID */
.weed,
.weed-right,
.quote-weed {
  filter: drop-shadow(0 0 4px rgba(255,255,255,0.35));
  transition: transform 0.4s ease, filter 0.4s ease;
}

/* quote weed size */
.quote-weed {
  width: 18px;
  vertical-align: middle;
  margin-left: 4px;
}

/* ğŸ’œ PURPLE HAZE MODE >200mg */
.weed-overdose {
  filter:
    drop-shadow(0 0 6px rgba(180,120,255,0.9))
    drop-shadow(0 0 14px rgba(140,60,255,0.8))
    drop-shadow(0 0 26px rgba(90,0,180,0.6));
  animation: purplePulse 2.2s ease-in-out infinite;
}

@keyframes purplePulse {
  0%   { transform: scale(1); }
  50%  { transform: scale(1.3); }
  100% { transform: scale(1); }
}
    </style>
  </head>
  <body>
    <div id="forceRefreshBtn" onclick="forceRefresh()">âŸ³</div>

    <div class="title-wrapper">
      <img src="weed.webp" class="weed" alt="weed left">
      <h1>SkÃ¦kkulator</h1>
      <img src="weed.webp" class="weed-right" alt="weed right">
    </div>

    <div class="checkbox-inline">
      <label for="manualInput">Manual input</label>
      <input id="manualInput" type="checkbox">
    </div>

    <label>Gram hasj:</label>
    <input id="grams" type="number" min="0" step="0.01" value="1">

    <label>Styrke pÃ¥ hasj:</label>
    <select id="strengthSelect">
      <option value="0.10">Svak (~10% THC)</option>
      <option value="0.15">Middels (~15% THC)</option>
      <option value="0.20">Sterk (~20% THC)</option>
      <option value="0.25">Ekstra sterk (~25% THC)</option>
      <option value="0.4">Psykopat (~40% THC)</option>
      <option value="0">Ukjent (bruk gjennomsnitt 15%)</option>
    </select>

    <input
      id="strengthManual"
      type="number"
      min="0"
      max="100"
      step="0.1"
      placeholder="THC %"
      style="display:none;">

    <label>Konsistens:</label>
    <select id="consistency">
      <option value="0.92">TÃ¸rr / lys</option>
      <option value="1">Mellom</option>
      <option value="1.08">Oljete / mÃ¸rk</option>
      <option value="1">Ukjent</option>
    </select>

    <div class="row">
      <div class="col">
        <label>Type melk:</label>
        <select id="milkSelect">
          <option value="0.005">Ekstra lett (0.5% fett)</option>
          <option value="0.01">Lett (1.0% fett)</option>
          <option value="0.0225">Lett + Hel (2.25% fett)</option>
          <option value="0.02">Ekstra + Hel (2.0% fett)</option>
          <option value="0.035">Helmelk (3.5% fett)</option>
        </select>
        <input
          id="milkManual"
          type="number"
          min="0"
          step="0.1"
          placeholder="Fett % melk"
          style="display:none;">
        <small>Velg den melketypen du bruker â€” fett Ã¸ker hvor mye THC som lÃ¸ses i blandingen.</small>
      </div>
      <div class="col">
        <label>SjokopÃ¥legg:</label>
        <select id="chocoFatSelect">
          <option value="0.309">Nutella (30.9%)</option>
          <option value="0.36">Coop Extra (36.0%)</option>
          <option value="0.365">First Price (36.5%)</option>
        </select>
        <input
          id="chocoFatManual"
          type="number"
          min="0"
          step="0.1"
          placeholder="Fett % sjokopÃ¥legg"
          style="display:none;">
        <small>Dette representerer fettandelen i sjokopÃ¥legget â€” hÃ¸yere fett betyr mer effektiv lÃ¸sing av THC i fettfase.</small>
      </div>
    </div>

    <div class="checkbox-inline">
      <label for="useChocoButter">SjokosmÃ¸r?</label>
      <input id="useChocoButter" type="checkbox" checked>
    </div>

    <label>Antall kopper (fordeling):</label>
    <input id="cups" type="number" min="1" step="1" value="1">

    <button onclick="calculateTHC()">Regn THC per kopp</button>

    <div id="result">
      <div id="warn" class="warn"></div>
      <div id="out"></div>
      <div class="meta" id="metaSources"></div>
    </div>

    <script>
document.getElementById('manualInput').addEventListener('change', function () {

  const show = this.checked;

  document.getElementById('strengthSelect').style.display = show ? 'none' : 'block';
  document.getElementById('strengthManual').style.display = show ? 'block' : 'none';

  document.getElementById('milkSelect').style.display = show ? 'none' : 'block';
  document.getElementById('milkManual').style.display = show ? 'block' : 'none';

  document.getElementById('chocoFatSelect').style.display = show ? 'none' : 'block';
  document.getElementById('chocoFatManual').style.display = show ? 'block' : 'none';
});

function chooseQuote() {
  const quotes = [
    "Bare kos deg a, ikke stress â€“ livet er bare kakao og fred wallah â˜•ğŸŒ¿",
    "Chill litt brur, sett deg i sofaen, spill noe musikk og smelt inn i universet ğŸ¶",
    "En kopp med ro wallah, ikke mer ikke mindre ğŸ˜Œ",
    "THC + kakao = kjÃ¦rlighet med fett bror ğŸŒˆ",
    "Du er trygg, du er myk, du er varm â€“ som sjokolade i panna wallah ğŸ˜´",
    "Alt gÃ¥r sakte nÃ¥, men riktig ass ğŸ«",
    "Livet er fett, literally brur ğŸ’ª",
    "Du blir ikke hÃ¸y, du blir opplyst wallah ğŸ”¥",
    "Sofaen vant kampen bror, gi opp ğŸ›‹ï¸",
    "Teppelivet er valgt ass, wallah ğŸ« ",
    "Universet nikker tilbake til deg brur ğŸŒŒ",
    "Ikke stress nÃ¥, wallah du dÃ¸r ikke, bare chill ğŸ˜­",
    "Wallah du dÃ¸r brurâ€¦ neida, bare kos ğŸ˜‚ğŸŒ¿"
  ];

  let q = quotes[Math.floor(Math.random() * quotes.length)];

  // 40% sjanse: bytt ALLE emojis med weed.webp
  if (Math.random() < 0.4) {
    q = q.replace(
    /[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu,
    '<img src="weed.webp" class="quote-weed weed">'
  );
  }

  return q;
}

function calculateTHC() {
  // Spill bong-lyd
  var bong = document.getElementById('bongSound');
  if (bong) {
    bong.currentTime = 0;
    bong.play().catch(() => {});
  }
  const grams = parseFloat(document.getElementById('grams').value) || 0;
  const consistency = parseFloat(document.getElementById('consistency').value) || 1;
  const cups = Math.max(1, parseInt(document.getElementById('cups').value) || 1);
  const useChocoButter = document.getElementById('useChocoButter').checked;
  const manual = document.getElementById('manualInput').checked;

  let strength;
  let milkFat;
  let chocoFat;

  if (manual) {
    strength = (parseFloat(document.getElementById('strengthManual').value) || 0) / 100;
    milkFat  = (parseFloat(document.getElementById('milkManual').value) || 0) / 100;
    chocoFat = (parseFloat(document.getElementById('chocoFatManual').value) || 0) / 100;
  } else {
    strength = parseFloat(document.getElementById('strengthSelect').value);
    milkFat  = parseFloat(document.getElementById('milkSelect').value) || 0.01;
    chocoFat = parseFloat(document.getElementById('chocoFatSelect').value) || 0.309;
  }

  if (strength === 0) strength = 0.15;

  const totalTHC_raw = grams * strength * 1000;

  let fatScore = milkFat * 100;
  fatScore = fatScore * 0.6;

  if (useChocoButter) fatScore += chocoFat * 100 * 0.9;
  else fatScore += chocoFat * 100 * 0.45;

  const fatMultiplier = 0.55 + fatScore / 100;

  const totalTHC_available = totalTHC_raw * consistency * fatMultiplier;
  const thcPerCup = totalTHC_available / cups;
  const percentOfRawPerCup = totalTHC_raw > 0
    ? (thcPerCup / totalTHC_raw) * 100
    : 0;

  let effect = '';
  if (thcPerCup < 10) effect = 'Mild';
  else if (thcPerCup < 30) effect = 'Middels';
  else if (thcPerCup < 60) effect = 'Sterk';
  else effect = 'Ekstrem';

  const warnEl = document.getElementById('warn');

  if (thcPerCup > 50) {
    warnEl.style.display = 'block';
    warnEl.innerHTML =
      'âš ï¸ Advarsel: HÃ¸y dose (over 50 mg THC per kopp).\nTa det rolig, start med en liten mengde, ha vann og snacks tilgjengelig â€” og kos deg.';
  } else {
    warnEl.style.display = 'none';
  }

    // --- REAL INFUSION LOGIC (V1+) ---
    const thcLoad = grams * strength * 1000;

    // effektiv fettkapasitet (samme logikk som resten av kalkulatoren)
    const effectiveFat =
      (milkFat * 100 * 0.6) +
      (chocoFat * 100 * (useChocoButter ? 0.9 : 0.45));

    // sikkerhet mot null / tull
    const safeFat = Math.max(1, effectiveFat);

    // hvor hardt THC belaster fettet
    const thcPerFatUnit = thcLoad / safeFat;

    let extraTime;

    if (thcPerFatUnit < 3) {
      extraTime = 2;
    } else if (thcPerFatUnit < 6) {
      extraTime = 4;
    } else if (thcPerFatUnit < 10) {
      extraTime = 6;
    } else if (thcPerFatUnit < 15) {
      extraTime = 9;
    } else if (thcPerFatUnit < 22) {
      extraTime = 12;
    } else {
      extraTime = 15;
    }

    // smÃ¥ justeringer basert pÃ¥ konsistens
    if (consistency > 1) extraTime -= 1;
    if (consistency < 1) extraTime += 1;

    // caps sÃ¥ det aldri blir idiotisk
    extraTime = Math.min(20, Math.max(2, Math.round(extraTime)));

  const quote = chooseQuote();

document.getElementById('result').style.display = 'block';


  // --- bare oppdater innhold, ikke append ny div ---
    out.innerHTML = `
      <strong>Omtrentlig THC per kopp:</strong> ${thcPerCup.toFixed(1)} mg<br>
      <small>(${percentOfRawPerCup.toFixed(1)}% av rÃ¥-THC per kopp)</small><br>
      <strong>Estimert effekt:</strong> ${effect}<br>
      <strong>Anbefalt ekstra varighet:</strong> ca ${extraTime} minutter ekstra for best infusjon.<br>
      <div style="margin-top:8px;"><em>${quote}</em></div>
    `;


  // === PURPLE HAZE MODE ===
document.querySelectorAll('.weed, .weed-right, .quote-weed').forEach(el => {
  el.classList.remove('weed-overdose');
  if (thcPerCup >= 200) {
    el.classList.add('weed-overdose');
  }
});

  // vis result (kun Ã©n boks)
  document.getElementById('result').style.display = 'block';

  const meta = document.getElementById('metaSources');
  meta.innerHTML = 'Kilder: THC er fettlÃ¸selig og varme aktiverer THCA â†’ THC (NCBI/PMC, oversiktsartikler).';
}

// --- DEV: Force Refresh uten Ã¥ slette tabeller ---
function forceRefresh() {
  const url = new URL(window.location.href);
  url.searchParams.set('v', Date.now());
  window.location.href = url.toString();
}
</script>

</body>
</html>